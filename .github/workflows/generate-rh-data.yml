---
name: Generate RH Data

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"
  push:
    branches:
      - main
      - klaas-2025-002

env:
  DEFAULT_PYTHON: "3.13"

concurrency:
  group: generate-metadata

jobs:
  generate-metadata:
    name: Generate metadata
    runs-on: ubuntu-latest
    steps:
      - name: ⤵️ Check out code
        uses: actions/checkout@v4.2.2
      - name: 🏗 install AWS CLI and JQ
        run: sudo apt-get update && sudo apt-get install -y awscli jq
      - name: 🏗 Set up UV
        uses: astral-sh/setup-uv@v4.2.0
        with:
          version: "latest"
          python-version: ${{ env.DEFAULT_PYTHON }}
          enable-cache: true
      - name: 🏗 Install project dependencies
        run: uv sync --no-group dev
      - name: ⤵️ Download data from Cloudflare R2
        run: |
          mkdir -p ./output/plugin/diff
          aws s3 cp s3://rotorhazard-plugins/plugin/diff/after.json ./output/plugin/diff/before.json --endpoint-url=${{ secrets.CF_R2_ENDPOINT }} || echo "{}" > ./output/plugin/diff/before.json
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
      - name: 🏗 Generate metadata
        run: uv run python scripts/generate_metadata.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Validate output with JQ
        run: |
          jq -c . output/plugin/data.json
          jq -c . output/plugin/repositories.json
      - name: Generate diff
        run: |
          mv ./output/plugin/diff/ ./output/diff/
          diff -U 8 output/diff/before.json output/diff/after.json > output/diff/plugin.diff || true
          cat output/diff/plugin.diff
      - name: Upload metadata artifacts
        uses: actions/upload-artifact@v4.5.0
        with:
          name: plugin
          path: |
            output/plugin
            output/diff
          if-no-files-found: error
          retention-days: 7
